var pad;var loading;var panel;var button_start;var level_display;var background;var content_holder;var initial_columns=6;var initial_rows=6;var columns=initial_columns;var rows=initial_rows;var unit_size=20;var stage_width=780;var stage_height=750;var first_back_step;var end_x;var end_y;var grid;var cell_stack;var total_cells;var current_cell;var next_cell;var player_cell;var visited_cells;var current_x;var current_y;var endCell;var level=1;var level_total=10;var color_counter=0;var colors=new Array;var move_timer;var move_timer_value=250;var direction;var end;var load_delay_timer_value=1000;var player_end_timer;var player_end_timer_value=100;var player_end_counter;var player_end_max=4;var player_end_scale_reduce=.2;var player_end_rotation=20;var point_direction;var scale_value;var inital_sound=false;var sound_initial;var sound_success;Array.prototype.push_random=function(e){this.splice(generateRandom(0,this.length),0,e);};function init(){document.getElementById('game_container').style.display="inline";document.getElementById('loading_div').style.display="none";setInteractiveParameters();set_data();sound_initial=new Howl({src:['/shared/sound/sound_initial.mp3','/shared/sound_initial.ogg','/shared/sound/sound_initial.wav']});sound_success=new Howl({src:['/page/'+page+'/sound/sound_success.mp3','/page/'+page+'/sound/sound_success.ogg','/page/'+page+'/sound/sound_success.wav']});background=new MovieClip(document.getElementById('background').cloneNode(true));background.background_graphic=background.instance.querySelector("#background_graphic");stage.appendChild(background.instance);content_holder=new MovieClip(document.getElementById('content_holder').cloneNode(true));content_holder.x=390;content_holder.y=300;content_holder.transform();stage.appendChild(content_holder.instance);pad=new MovieClip(document.getElementById('pad').cloneNode(true));stage.appendChild(pad.instance);panel=new MovieClip(document.getElementById('panel').cloneNode(true));loading=new MovieClip(document.getElementById('loading').cloneNode(true));loading.x=390;loading.y=300;loading.scale=1.1;loading.transform();loading.load_timer
loading.load_timer_value=80;loading.counter_max=60;loading.background=loading.instance.querySelector("#loading_background");loading.arrow=new MovieClip(loading.instance.querySelector("#loading_arrow"));loading.load_play=function(){loading.counter++;loading.arrow.rotation+=20;loading.arrow.transform();}
loading.instance.setAttribute("display","none");panel.instance.appendChild(loading.instance);button_start=new MovieClip(document.getElementById('button_start').cloneNode(true));button_start.x=390;button_start.y=350;button_start.scale=3;button_start.transform();panel.instance.appendChild(button_start.instance);level_display=new MovieClip(document.getElementById('level_display').cloneNode(true));level_display.x=390;level_display.y=605;level_display.transform();level_display.text1=new MovieClip(level_display.instance.querySelector("#text_container1"));level_display.text2=new MovieClip(level_display.instance.querySelector("#text_container2"));level_display.text1.instance.textContent='Tap near the ship to make it move or use your arrow keys.';level_display.text2.instance.textContent='Select "Start" to begin.';panel.instance.appendChild(level_display.instance);stage.appendChild(panel.instance);document.onkeydown=key_down_handler;addPointerListeners();}
function start_game(){create_grid();}
function start_this(){clearInterval(loading.load_timer);end=false;panel.instance.setAttribute("display","none");pick_start_end();content_holder.instance.setAttribute("display","inline");if(color_counter==level_total){color_counter=1;}else{color_counter++;}
background.background_graphic.setAttribute("fill",colors[color_counter]);background.instance.setAttribute("display","inline");}
function create_grid(){first_back_step=true;end_x=0;end_y=0;grid=new Array();cell_stack=new Array();total_cells=columns*rows;visited_cells=1;for(var i=0;i<rows;i++){grid[i]=new Array();for(var k=0;k<columns;k++){grid[i][k]=new MovieClip(document.getElementById('cell').cloneNode(true));grid[i][k].x=k*unit_size;grid[i][k].y=i*unit_size;grid[i][k].transform();grid[i][k].frame_total=16;grid[i][k].frames=new Array;for(var m=1;m<=grid[i][k].frame_total;m++){grid[i][k].frames[m]=grid[i][k].instance.querySelector("#frame"+m);}
grid[i][k].exit=new MovieClip(grid[i][k].instance.querySelector("#exit"));grid[i][k].exit.instance.setAttribute("display","none");grid[i][k].player=new MovieClip(grid[i][k].instance.querySelector("#player"));grid[i][k].player.instance.setAttribute("display","none");grid[i][k].player.animationTimerValue=400;grid[i][k].player.frame_total=2;grid[i][k].player.frames=new Array;for(var m=1;m<=grid[i][k].player.frame_total;m++){grid[i][k].player.frames[m]=grid[i][k].player.instance.querySelector("#player_frame"+m);}
grid[i][k].player.thrust=[2,1];grid[i][k].visited=false;grid[i][k].wall_north=true;grid[i][k].wall_east=true;grid[i][k].wall_south=true;grid[i][k].wall_west=true;grid[i][k].grid_x=k;grid[i][k].grid_y=i;content_holder.instance.appendChild(grid[i][k].instance);}}
var content_width=columns*unit_size;var content_height=rows*unit_size;scale_value=stage_width/content_width;scale_value/=1.1;content_width*=scale_value;content_height*=scale_value;content_holder.scale=scale_value;content_holder.x=(stage_width-content_width)/2+(unit_size*scale_value)/2;content_holder.y=20+(unit_size*scale_value)/2;content_holder.transform();background.x=(stage_width-content_width)/2;background.y=20;background.background_graphic.setAttribute("width",content_width);background.background_graphic.setAttribute("height",content_height);background.transform();for(i=0;i<rows;i++){for(k=0;k<columns;k++){if(i>0){grid[i][k].cell_north=grid[i-1][k];}
if(k<columns-1){grid[i][k].cell_east=grid[i][k+1];}
if(i<rows-1){grid[i][k].cell_south=grid[i+1][k];}
if(k>0){grid[i][k].cell_west=grid[i][k-1];}}}
current_cell=grid[generateRandom(0,rows-1)][generateRandom(0,columns-1)];current_cell.visited=true;draw_walls();}
function remove_grid(){for(var i=0;i<rows;i++){for(var k=0;k<columns;k++){content_holder.instance.removeChild(grid[i][k].instance);}}}
function set_wall(mc,n,e,s,w){var f=16;if(n&&e&&s&&w){f=1;}else if(!n&&e&&s&&w){f=2;}else if(n&&!e&&s&&w){f=3;}else if(n&&e&&!s&&w){f=4;}else if(n&&e&&s&&!w){f=5;}else if(!n&&e&&s&&!w){f=6;}else if(!n&&!e&&s&&w){f=7;}else if(n&&!e&&!s&&w){f=8;}else if(n&&e&&!s&&!w){f=9;}else if(n&&!e&&s&&!w){f=10;}else if(!n&&e&&!s&&w){f=11;}else if(n&&!e&&!s&&!w){f=12;}else if(!n&&e&&!s&&!w){f=13;}else if(!n&&!e&&s&&!w){f=14;}else if(!n&&!e&&!s&&w){f=15;}else if(!n&&!e&&!s&&!w){f=16;}
mc.playFrames([f]);}
function draw_walls(){var test_neighbors=new Array();if(current_cell.cell_north!=undefined&&current_cell.cell_north.visited==false){test_neighbors.push_random(current_cell.cell_north);}
if(current_cell.cell_east!=undefined&&current_cell.cell_east.visited==false){test_neighbors.push_random(current_cell.cell_east);}
if(current_cell.cell_south!=undefined&&current_cell.cell_south.visited==false){test_neighbors.push_random(current_cell.cell_south);}
if(current_cell.cell_west!=undefined&&current_cell.cell_west.visited==false){test_neighbors.push_random(current_cell.cell_west);}
if(test_neighbors.length>0){next_cell=test_neighbors.pop();if(next_cell==current_cell.cell_north){next_cell.wall_south=false;current_cell.wall_north=false;}else if(next_cell==current_cell.cell_east){next_cell.wall_west=false;current_cell.wall_east=false;}else if(next_cell==current_cell.cell_south){next_cell.wall_north=false;current_cell.wall_south=false;}else if(next_cell==current_cell.cell_west){next_cell.wall_east=false;current_cell.wall_west=false;}
set_wall(current_cell,current_cell.wall_north,current_cell.wall_east,current_cell.wall_south,current_cell.wall_west);cell_stack.push(current_cell);current_cell=next_cell;set_wall(current_cell,current_cell.wall_north,current_cell.wall_east,current_cell.wall_south,current_cell.wall_west);current_cell.visited=true;visited_cells++;if(visited_cells==total_cells){start_this();}else{draw_walls();}}else{if(first_back_step){first_back_step=false;end_x=current_cell.grid_x;end_y=current_cell.grid_y;}
current_cell=cell_stack.pop();draw_walls();}}
function pick_start_end(){current_x=generateRandom(0,columns-1);current_y=generateRandom(0,rows-1);while(current_x==end_x&&current_y==end_y){current_x=generateRandom(0,columns-1);current_y=generateRandom(0,rows-1);}
player_cell=grid[current_y][current_x];player_cell.player.instance.setAttribute("display","inline");end_cell=grid[end_y][end_x];end_cell.exit.instance.setAttribute("display","inline");pad.instance.setAttribute('pointer-events','all');}
function move_to(chosen_direction){player_cell=grid[current_y][current_x];var next_cell=0;if(chosen_direction=="left"){if(player_cell.wall_west==false){next_cell=player_cell.cell_west;}}else if(chosen_direction=="right"){if(player_cell.wall_east==false){next_cell=player_cell.cell_east;}}else if(chosen_direction=="up"){if(player_cell.wall_north==false){next_cell=player_cell.cell_north;}}else if(chosen_direction=="down"){if(player_cell.wall_south==false){next_cell=player_cell.cell_south;}}
if(next_cell!=0){player_cell.player.instance.setAttribute("display","none");player_cell=next_cell;current_x=player_cell.grid_x;current_y=player_cell.grid_y;if(chosen_direction=="left"){player_cell.player.rotation=180;}else if(chosen_direction=="right"){player_cell.player.rotation=0;}else if(chosen_direction=="up"){player_cell.player.rotation=270;}else if(chosen_direction=="down"){player_cell.player.rotation=90;}
player_cell.player.transform();player_cell.player.instance.setAttribute("display","inline");player_cell.player.playFrames(player_cell.player.thrust);if(current_x==end_x&&current_y==end_y){pad.instance.setAttribute('pointer-events','none');sound_success.play();end=true;player_end_counter=0;player_end_timer=setInterval("player_end_timer_handler()",player_end_timer_value);}}}
function player_end_timer_handler(){player_end_counter++;if(player_end_counter<player_end_max){player_cell.player.scale-=player_end_scale_reduce;player_cell.player.rotation+=player_end_rotation;player_cell.player.transform();}else{player_cell.player.scale-=player_end_scale_reduce;player_cell.player.rotation+=player_end_rotation;player_cell.player.transform();clearInterval(player_end_timer);end_start();}}
function start_loader(){loading.counter=0;loading.background.setAttribute("fill",colors[level]);loading.instance.setAttribute("display","inline");loading.load_timer=setInterval("loading.load_play()",loading.load_timer_value);setTimeout("start_game()",load_delay_timer_value);level_display.text1.instance.textContent='Loading a new level';level_display.text2.instance.textContent='Level '+level;}
function end_start(){remove_grid();if(level<level_total){columns+=1;rows+=1;level++;start_loader();}else{level=1;color_counter=0;columns=initial_columns;rows=initial_rows;button_start.instance.setAttribute("display","inline");loading.instance.setAttribute("display","none");level_display.text1.instance.textContent='';level_display.text2.instance.textContent='You finished all the levels!';}
content_holder.instance.setAttribute("display","none");background.instance.setAttribute("display","none");panel.instance.setAttribute("display","inline");}
function start_handler(event){event.preventDefault();if(event.isPrimary){button_start.instance.setAttribute("display","none");if(!inital_sound){inital_sound=true;sound_initial.play();}
start_loader();}}
function move_product_handler(event){event.preventDefault();if(event.isPrimary){var maze_pointer=stage.createSVGPoint();maze_pointer.x=event.clientX;maze_pointer.y=event.clientY;var m=stage.getScreenCTM();maze_pointer=maze_pointer.matrixTransform(m.inverse());var product_x=content_holder.x/scale_value+(grid[current_y][current_x].x+(unit_size/2))*scale_value;var product_y=content_holder.y/scale_value+(grid[current_y][current_x].y+(unit_size/2))*scale_value;point_direction=0;var angle=getDirection(product_x,maze_pointer.x,product_y,maze_pointer.y,false)+180;if(angle>135&&angle<225){point_direction=1;}else if(angle>225&&angle<315){point_direction=2;}else if(angle>315){point_direction=3;}else if(angle<45){point_direction=3;}else if(angle>45&&angle<135){point_direction=4;}
switch(point_direction){case 1:left_handler();break;case 2:up_handler();break;case 3:right_handler();break;case 4:down_handler()
break;}}}
function left_handler(){direction="left";move_to(direction);}
function right_handler(){direction="right";move_to(direction);}
function up_handler(){direction="up";move_to(direction);}
function down_handler(){direction="down";move_to(direction);}
function swipeHandler(){switch(swipeDirection){case 1:left_handler();break;case 2:up_handler();break;case 3:right_handler();break;case 4:down_handler()
break;}}
function key_down_handler(event){switch(event.keyCode){case 37:left_handler();break;case 38:up_handler();break;case 39:right_handler();break;case 40:down_handler()
break;}}
function set_data(){colors[1]='#B049F2';colors[2]='#018BF1';colors[3]='#37CE21';colors[4]='#F94F21';colors[5]='#DDC017';colors[6]='#3AC9B8';colors[7]='#B049F2';colors[8]='#78C626';colors[9]='#6F6FF7';colors[10]='#F471B6';colors[11]='#24D151';colors[12]='#DD4EDD';colors[13]='#8F64F9';colors[14]='#08B5F9';colors[15]='#F9466C';}
function addPointerListeners(){button_start.instance.addEventListener("pointerdown",start_handler,false);pad.instance.addEventListener("pointerdown",move_product_handler,false);}